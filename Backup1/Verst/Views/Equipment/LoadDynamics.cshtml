@using MvcApplication.Models

@{
    ViewBag.Title = "Динамика загрузки";
    Layout = Request.IsAjaxRequest() != true ? "~/Views/Shared/_Layout.cshtml" : null;
    string prN = FoxRepo.GetProductionNumber();
}

@Html.Hidden("PageTitle", "Динамика загрузки")

<link href="@Url.Content("~/Content/jquery.jqplot.min.css")" rel="stylesheet" type="text/css" />
<!--[if IE]><script language="javascript" type="text/javascript" src="@Url.Content("~/Scripts/excanvas.js")"></script><![endif]--> 
<script type="text/javascript" src="@Url.Content("~/Scripts/jquery.jqplot.min.js")" ></script>
<script src="@Url.Content("~/Scripts/jqPlot_Full.js")" type="text/javascript"></script>
<script src="@Url.Content("~/Scripts/CommonScripts.js")" type="text/javascript"></script>

<h2>Динамика загрузки оборудования за текущий месяц</h2>
<div style="width: 958px;position: relative;">
    <div style="width: 450px;float: left;">
        <input type="button" value="Предыдущий месяц" onclick="PrevMonth()" class="btn btn-primary"/>
        <input type="button" value="Следующий месяц" onclick="NextMonth()" class="btn btn-primary"/>
        <input type="button" value="За текущий год" onclick="ForThisYear()" class="btn btn-primary"/>
    </div>
    <div class="progress progress-striped" id="ProgressBar" style="width: 508px; min-width: 300px;">
        <div class="bar" style="width: 100%;"></div>
    </div>
    <div id="LoadDynamicsPlot" class="jqplot-target" style="width: 960px; height: 1524px;">
        <img src="@Url.Content("~/Content/images/ajax-loader.gif")"/> ...Подождите, идёт построение...
    </div>
</div>

<script type="text/javascript">
    var plot;
    var plotOptions;
    
    var prevkpr, prevnop;
    var Month, Year, monthCounter, yearCounter;

    $.get('@Url.Action("Sidemenu","Home")').success(function (result) { $('#SideMenu').html(result); });
    $('#SideMenu').show();

    $(document).ready(function () {
        var fullDate = new Date();
        Month = fullDate.getMonth();
        Year = fullDate.getFullYear();
        monthCounter = Month;
        yearCounter = Year;
        $('input[type=button]').eq(1).attr('disabled', true);

        $.ajax({
            url: '@Url.Action("LdPlot","Equipment")',
            type: 'GET',
            onbegin: AjaxBegin(),
            success: function (result) {
                makingPlot(result.Kpls, result.Ust);
                AjaxSuccessEnd();
            },
            error: function () { AjaxError(); }
        });
    });

    function PrevMonth() {
        AjaxBegin();
        GetByMonth("Prev");
    }

    function NextMonth() {
        AjaxBegin();
        GetByMonth("Next");
    }

    function ForThisYear() {
        $.get('@Url.Action("LdPlotYear","Equipment")').success(function (result) {
            $('h2').html("Динамика загрузки оборудования производства №" + @prN + " за " + Year + " год");
            makingPlot(result.Kpls, result.Ust);
        });
    }

    function GetData(month, year) {
        $.ajax({
            url: '@Url.Action("LdPlotByDate")',
            type: 'GET',
            data: { month: (month + 1), year: year },
            success: function (result) {
                makingPlot(result.Kpls, result.Ust);
                $('h2').html("Динамика загрузки оборудования производства №" + @prN + " за " + FuckingIEHack(Month) + " " + Year);
                AjaxSuccessEnd();
            },
            error: function () { AjaxError(); }
        });
    }

    function GetByMonth(step) {
        if (step == "Prev") {
            if (Month != 0) {
                Month = --Month;
            } else {
                Month = 11;
                Year = Year - 1;
            }
            $('input[type=button]').eq(1).attr('disabled', false);
            GetData(Month, Year);
        } else {
            if (Month == monthCounter - 1 && Year == yearCounter) {
                $('input[type=button]').eq(1).attr('disabled', true);
            }
            if (Month != 11 && (Month != monthCounter || Year != yearCounter)) {
                Month = ++Month;
                GetData(Month, Year);
            } else {
                Month = 0;
                Year = ++Year;
                GetData(Month, Year);
            }
        }
    }

    function makingPlot(data, labels) {
        
        plotOptions = {
            animate: true,
            animateReplot: true,
            seriesDefaults: {
                label: "Брак",
                renderer: $.jqplot.BarRenderer,
                pointLabels: { show: true, location: 'e', edgeTolerance: -15 },
                shadowAngle: 135,
                rendererOptions: {
                    barDirection: 'horizontal',
                    highlightMouseDown: true
                }
            },
            axes: {
                xaxis: {
                    tickOptions: { angle: 30 }
                },
                yaxis: {
                    label: "Установки",
                    ticks: labels,
                    renderer: $.jqplot.CategoryAxisRenderer,
                    tickRenderer: $.jqplot.CanvasAxisTickRenderer
                }
            }
        };

        plot = $.jqplot('LoadDynamicsPlot', [data], plotOptions);
        plot.replot();
    }
</script>