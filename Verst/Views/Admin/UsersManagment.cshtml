@{
    ViewBag.Title = "Управление пользователями";
    Layout = Request.IsAjaxRequest() != true ? "~/Views/Shared/_Layout.cshtml" : null;
}

@Html.Hidden("PageTitle", "Управление пользователями")

<script type="text/javascript">
    $(document).ready(function () {
        $('#SideMenu').hide();
    });
    
    function crRole() {
        var rolename = $('input[name="RoleName"]').val();
        $.ajax({
            url: '@Url.Action("CreateRole")',
            type: 'POST',
            data: { newRole: rolename },
            success: function (result) {
                $('#RoleCreation').modal("hide");
                alert(result);
                UpdateRolesList();
            },
            error: function (err) { alert(err); },
            traditional: true
        });
    }
    function delRole(roleId) {
        $.ajax({
            url: '@Url.Action("DeleteRole")',
            type: 'POST',
            data: { roleName: roleId },
            success: function (result) {
                alert(result);
                UpdateRolesList();
            },
            error: function (err) { alert(err); },
            traditional: true
        });
    }
    function crUser() {
        var username = $('input[name="UserName"]').val();
        var fio = $('input[name="FIO"]').val();
        var unit = $('input[name="Unit"]').val();
        var password = $('input[name="Password"]').val();
        $.ajax({
            url: '@Url.Action("CreateUser")',
            type: 'POST',
            data: { username: username, fio: fio, unit: unit, password: password},
            success: function (result) {
                $('#UserCreation').modal("hide");
                alert(result);
                UpdateUserList();
            },
            error: function (err) { alert(err); },
            traditional: true
        });
    }
    function delUser(username) {
        $.ajax({
            url: '@Url.Action("DeleteUser")',
            type: 'POST',
            data: { userName: username },
            success: function (result) {
                alert(result);
                UpdateUserList();
            },
            error: function (err) { alert(err); },
            traditional: true
        });
    }
    function BeginCacheRefreshing() {
        $('#Admin_ActionsStatus').html('<span class="loader" style="width: 30px; height: 30px;"></span> <span style="margin-left: 35px; font-size: 30px;">Запущено обновление кэша!</span>');
    }
    function CacheRefFail(result) {
        $('#Admin_ActionsStatus').addClass('label').addClass('label-important').html(result);
    }

    function UnblockUser(username) {
        $.ajax({
            url: '@Url.Action("UnblockUser")',
            type: 'POST',
            data: { username: username },
            success: function (result) {
                alert(result);
                UpdateUserList();
            },
            error: function (err) { alert(err); },
            traditional: true
        });
    }
    function BlockUser(username) {
        $.ajax({
            url: '@Url.Action("BlockUser")',
            type: 'POST',
            data: { username: username },
            success: function (result) {
                alert(result);
                UpdateUserList();
            },
            error: function (err) { alert(err); },
            traditional: true
        });
    }

    function UpdateUserList() {
        $.ajax({
            url: '@Url.Action("GetUsersList")',
            type: 'GET',
            beforeSend: function () { $('#Admin_UsersList').html("Подождите, идёт загрузка пользователей!"); },
            success: function (result) {
                $('#Admin_UsersList').html(result);
            },
            error: function (err) { $('#Admin_RolesList').html(err); },
            traditional: true
        });
    }
    function UpdateRolesList() {
        $.ajax({
            url: '@Url.Action("GetRolesList")',
            type: 'GET',
            beforeSend: function () { $('#Admin_RolesList').html("Подождите, идёт загрузка ролей!"); },
            success: function (result) {
                $('#Admin_RolesList').html(result);
            },
            error: function (err) { $('#Admin_RolesList').html(err); },
            traditional: true
        });
    }
</script>

<div id="Admin_ActionsPanel">
    <h2>Возможные действия:</h2>
    <span id="Admin_ActionsStatus" style="width: 100%; text-align: center; background-color: yellow; margin-bottom: 5px;"></span><br/>
    <a href="#UserCreation" role="button" class="btn" data-toggle="modal">Создать пользователя</a>
    <a href="#RoleCreation" role="button" class="btn" data-toggle="modal">Создать роль</a>
    @Html.ActionLink("Просмотр логов", "ShowLogs", "Admin", null, new { Class = "navigator btn", @role = "button" })
    @Ajax.ActionLink("Очистить весь кэш", "ClearCache", null, new AjaxOptions { HttpMethod = "POST", InsertionMode = InsertionMode.Replace, UpdateTargetId = "Admin_ActionsStatus" }, new { @class = "btn", @role = "button" })
    @Ajax.ActionLink("Обновить кэш циклов", "RefreshCyclesCache", null, new AjaxOptions { HttpMethod = "POST", InsertionMode = InsertionMode.Replace, UpdateTargetId = "Admin_ActionsStatus", OnBegin = "BeginCacheRefreshing()", OnFailure = "CacheRefFail()" }, new { @class = "btn", @role = "button" })
</div>
<div class="row-fluid">
    <div style="width: 450px">
        <h2 style="text-align: center">Пользователи</h2>
        <div id="Admin_UsersList">
            @Html.Action("GetUsersList")
        </div>
    </div>

    <div style="width: 450px; float: left;">
        <h2 style="text-align: center">Роли</h2>
        <div id="Admin_RolesList">
            @Html.Action("GetRolesList")
        </div>
    </div>
</div>

<div class="modal hide fade" id="RoleCreation">
    <div class="modal-header">
        <h3>Создание роли</h3>
    </div>
    <div class="modal-body">
        <p>Введите название роли:</p>
        <input type="text" name="RoleName"/>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-primary" name="CreateRoleBtn" onclick="crRole()">Создать</button>
        <button type="button" class="btn btn-primary" data-dismiss="modal">Отмена</button>
    </div>
</div>

<div class="modal hide fade" id="UserCreation">
    <div class="modal-header">
        <h3>Создание пользователя</h3>
    </div>
    <div class="modal-body">
        <p>Введите логин пользователя:</p>
        <input type="text" name="UserName"/>
        <p>Введите Ф.И.О. пользователя:</p>
        <input type="text" name="FIO"/>
        <p>Введите подразделение:</p>
        <input type="text" name="Unit"/>
        <p>Введите пароль:</p>
        <input type="text" name="Password"/>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-primary" name="CreateRoleBtn" onclick="crUser()">Создать</button>
        <button type="button" class="btn btn-primary" data-dismiss="modal">Отмена</button>
    </div>
</div>